#!/usr/bin/env ruby

# frozen_string_literal: false

# *************************************************************************** #
#                                  LOAD PATHS                                 #
# *************************************************************************** #
begin
  # Bundler dependencies
  require 'rubygems'
  require 'bundler/setup'

  require 'pry-byebug'

  require 'observer'

  # Setup load path for application (makes you realise RubyGems spoils you...)
  def setup_path(dir)
    load_path = File.expand_path(File.dirname(__FILE__) + "/../#{dir}")
    $LOAD_PATH.unshift(load_path) unless $LOAD_PATH.include?(load_path)
  rescue StandardError => e
    puts e
    e.backtrace.each { |line| puts line }
    exit
  end

  require 'log_actually'

  setup_path('lib')
  setup_path('src')

  LOGGER = LogActually.is_all_around(:default)
  LOGGER.i

  require 'helpers/manageable_threads'
  require 'yabber/yabber'

  require 'modules'
rescue LoadError => e
  # LogActually.default.error('run') { e }
  puts e
  e.backtrace.each { |line| puts line }
  $LOAD_PATH.each { |line| puts line }
  exit
rescue StandardError => e
  puts e
  e.backtrace.each { |line| puts line }
  exit
end

# *************************************************************************** #
#                                 APPLICATION                                 #
# *************************************************************************** #

PROC = 'Walter'.freeze

LOGGER.info(PROC) { "BMW I/K-BUS Interface" }

begin
  require 'walter'
  app = Walter.new
  app.launch
rescue Interrupt
  Signal.trap(0, proc { puts "Terminating: #{$$}" })
  LOGGER.close
  return 1
rescue LoadError => e
  LOGGER.error('run') { 'Application LoadError' }
  LOGGER.error('run') { e }
  e.backtrace.each { |line| LOGGER.warn('run') { line } }
  # $LOAD_PATH.each { |line| LOGGER.warn('run') { line } }
  exit(false)
rescue StandardError => e
  LOGGER.error('run') { 'Rescued at bin/run' }
  LOGGER.error('run') { e }
  e.backtrace.each { |line| LOGGER.error('run') { line } }
  LOGGER.close
  exit(false)
rescue SystemExit
  puts "rescued a SystemExit exception"
end

return 0
