#!/usr/bin/env ruby

# Bundler dependencies
require 'rubygems'
require 'bundler/setup'

require 'pry-byebug'

# Setup load path for application (makes you realise RubyGems spoils you...)
lib_path = File.expand_path(File.dirname(__FILE__)+ '/../lib')
ext_path = File.expand_path(File.dirname(__FILE__)+ '/../ext')
$LOAD_PATH.unshift(lib_path) unless $LOAD_PATH.include?(lib_path)
$LOAD_PATH.unshift(ext_path) unless $LOAD_PATH.include?(ext_path)

require 'cheap_logger'
LOGGER = get_logger

# *************************************************************************** #
#                             DISENGAGE THE LAZY!                             #
# *************************************************************************** #

require 'yabber/yabber'
require 'walter'

PROC = 'Walter'.freeze

LOGGER.info(PROC) { "BMW I/K-BUS Interface" }

begin
  app = Walter.new
  app.launch
rescue Interrupt
  Signal.trap(0, proc { puts "Terminating: #{$$}" })
  LOGGER.close
  return 1
rescue StandardError => e
  LOGGER.error('Bash') { 'Rescued at run:59'}
  LOGGER.error e.message
  e.backtrace.each { |e| LOGGER.error e }
  binding.pry
  LOGGER.close
  return 1
end

return 0
